#!/bin/bash

echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Telegram –±–æ—Ç–∞..."

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ -d "venv" ]; then
    source venv/bin/activate
fi

# –ò—Å–ø–æ–ª—å–∑—É–µ–º Python –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
python -c "
import sys
sys.path.append('.')
from process_manager import ProcessManager

manager = ProcessManager()
processes = manager.find_bot_processes()

if not processes:
    print('‚ÑπÔ∏è  –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω')
    exit(0)

print(f'üìã –ù–∞–π–¥–µ–Ω–æ {len(processes)} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞:')
manager.print_status()

print('üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã...')
stopped = manager.stop_all_bot_processes()

if stopped > 0:
    print('‚è≥ –ñ–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...')
    if manager.wait_for_processes_to_stop():
        print('‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')
    else:
        print('‚ö†Ô∏è  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...')
        manager.stop_all_bot_processes(force=True)
        print('‚úÖ –ë–æ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')
else:
    print('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞')
    exit(1)
"

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞"
    exit 1
fi
